#!/usr/local/bin/php
<?php
$file = __DIR__ . '/../coverage/index.xml';
$threshold = $argv[1];
$warningThresold = $argv[2];

$coverage = simplexml_load_file($file);
$ratio = (double) $coverage->project->directory->totals->lines["percent"];

echo "Line coverage: $ratio%
";
echo "Threshold: $threshold%
";

$im = imagecreatefrompng("tests/img/coverage-badge-template.png");
if ($ratio > $threshold) {
    $color = imagecolorallocate($im, 0, 0, 0);
} else {
    $color = imagecolorallocate($im, 255, 0, 0);
}
if ($ratio > $warningThresold) {
    $color = imagecolorallocate($im, 21, 120, 17);
}

if ($ratio < 100) {
    $ratioString = number_format($ratio, 2) . '%';
    $start_x = 25;
    $start_y = 93;
    $fontSize = 24;
} else {
    $ratioString = '100%';
    $start_x = 30;
    $start_y = 100;
    $fontSize = 32;
}
imagefttext($im, $fontSize, 0, $start_x, $start_y, $color, '/usr/share/fonts/truetype/liberation/LiberationMono-Regular.ttf', $ratioString);
imagepng($im, 'img/coverage-badge.png');

if ($ratio < $threshold) {
    echo "FAILED!
";
    exit(-1);
}

echo "SUCCESS!
";
