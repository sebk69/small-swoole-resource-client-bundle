#!/bin/bash

# $1 : version type

set -e

docker compose up -d --build

docker exec -it small-swoole-resource-client-bundle composer update
docker exec -it small-swoole-resource-client-bundle composer analyse
docker exec -it small-swoole-resource-client-bundle bin/unit-tests

# Publish only on master branch
if [ "$(git status | grep 'On branch' | grep 'main')" == "" ]
then
  if [ "$(git status | grep 'Sur la branche' | grep 'main')" == "" ]
  then
    printf "\e[31mYou can tag and publish only on main !!!\e[0m\n"
    exit 1
  fi
fi

# Get old version
version="$(cat .version)"
version_type=$1
vparts=(${version//./ })
major="${vparts[0]}"
medium="${vparts[1]}"
minor="${vparts[2]}"

# Upgrade version
if [ "$version_type" == "--minor" ]
then
  minor=$(expr $minor + 1)
else
  if [ "$version_type" == "--medium" ]
  then
    medium=$(expr $medium + 1)
    minor=0
  else
    if [ "$version_type" == "--major" ]
    then
      major=$(expr $major + 1)
      medium=0
      minor=0
    else
      printf "\e[31mYou must specify --minor, --medium or --major !!!\e[0m\n"
      exit 1
    fi
  fi
fi
version="$major.$medium.$minor"

printf "\e[32mPublish version $version release...\e[0m\n"

# Store version
echo $version > .version

# Tag commit
if ! ssh-add -l >/dev/null 2>&1; then
  eval "$(ssh-agent -s)"
  ssh-add ~/.ssh/id_ed25519   # ou ~/.ssh/id_rsa si tu utilises RSA
fi
git add --all
git commit -m "Tag $version"
git push
git tag $version
git push --tags
